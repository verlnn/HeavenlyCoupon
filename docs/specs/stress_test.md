# 부하 테스트 명세서 – 초당 60~70만 TPS 쿠폰 발행 요청

본 문서는 **HeavenlyCoupon** 프로젝트에서 대용량 실시간 쿠폰 발행을 검증하기 위한  
**초당 60~70만 트래픽(TPS) 부하 테스트 코드 및 기준 명세**를 정의합니다.

본 명세서는 구현 이전에 고정되는 **계약 문서**이며,  
모든 부하 테스트 코드는 본 문서를 기준으로 작성되어야 합니다.

---

## 1. 목적

- 대규모 동시 요청 환경에서 시스템의 **처리 한계(TPS)** 및 **안정성**을 검증
- Redis 기반 쿠폰 발행 로직의 **정합성 보장 여부** 확인
- 이후 Redis 전략(DECR / Lua / Queue)별 성능 비교의 기준선 확보

---

## 2. 테스트 목표

| 항목 | 목표 값 |
|---|---|
| 요청 처리량 | 초당 **600,000 ~ 700,000 TPS** |
| 총 요청 수 | 최소 **10,000,000 요청** |
| 요청 방식 | HTTP API (POST) |
| 요청 성공률 | 99.9% 이상 |
| 중복 발행 | **0건** |
| 초과 발행 | **0건** |

---

## 3. 테스트 대상 API 명세

### 3.1 Endpoint

```
POST /api/v1/coupons/{couponId}/issue
```

### 3.2 Request Body

```json
{
  "userId": "string",
  "requestId": "uuid"
}
```

- `userId`
  - 테스트용 가상 사용자 ID
  - 전체 테스트 동안 **중복 없이 생성**
- `requestId`
  - 멱등성 보장을 위한 요청 식별자
  - 요청당 1개 UUID

---

## 4. 부하 발생 방식 명세

### 4.1 부하 발생 주체

- 단일 프로세스 기준으로는 TPS 한계가 명확하므로
- **다중 프로세스 또는 분산 부하 발생기**를 전제로 함

예:
- Local: 멀티 JVM + 비동기 HTTP Client
- 추후 확장: k6 / Gatling / custom Java load generator

---

### 4.2 요청 생성 규칙

- 요청은 **균등 분산**으로 발생
- 특정 userId에 요청이 몰리지 않도록 사전 분산
- 동일 userId에 대한 중복 요청은 **의도적으로 생성하지 않음**
  - (중복 테스트는 별도 시나리오에서 수행)

---

### 4.3 TPS 제어 기준

- 목표 TPS 도달까지 **점진적 증가 방식**
  - 100k → 300k → 500k → 700k
- 각 단계별로 최소 30초 이상 유지

---

## 5. 성공/실패 판단 기준

### 5.1 성공 기준

- HTTP Status: `202 Accepted`
- 응답 시간(P99): 목표 TPS 구간에서도 급격한 증가 없음
- 서버 오류(5xx) 비율: 0.1% 이하

### 5.2 실패 기준

- 응답 타임아웃 다수 발생
- TPS 유지 불가(지속 하락)
- 서버 OOM, Redis 연결 실패, 스레드 고갈 발생 시 즉시 중단

---

## 6. 수집 지표(Metrics)

부하 테스트 중 반드시 수집해야 할 지표는 아래와 같습니다.

### 6.1 API 서버

- TPS / RPS
- 평균 응답 시간 / P95 / P99
- 활성 스레드 수
- GC 발생 횟수 및 소요 시간

### 6.2 Redis

- 초당 명령 처리 수
- Command Latency
- CPU 사용률
- 네트워크 I/O

### 6.3 Kafka (연동 시)

- Producer 처리량
- 메시지 적재 지연
- Consumer Lag

---

## 7. 테스트 결과 산출물

부하 테스트 종료 후 아래 산출물을 반드시 남깁니다.

- 테스트 환경 정보
  - 서버 스펙
  - Redis 구성
  - JVM 옵션
- 최대 안정 TPS
- 장애 발생 시점 및 원인
- Redis 전략별 비교 결과(후속 문서 링크)

---

## 8. TDD 관점 유의사항

- 본 부하 테스트는 **기능 테스트가 아닌 시스템 테스트**
- 단위 테스트/통합 테스트와 분리하여 관리
- 실패 케이스도 명세로 남겨 **재현 가능**해야 함

---

## 9. 비고

- 본 명세서는 향후 Redis Lua Script / Queue 방식 테스트의 **기준선(Baseline)** 으로 사용
- 변경 시 반드시 명세서 버전 관리 수행
